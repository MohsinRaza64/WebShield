import os
import sys
from time import sleep

parent_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(parent_dir)

import hashlib
import pathlib
import platform
import time
from datetime import datetime
from misp.misp import get_sha256_hashes
from utils.file_handler import append_to_file

import yara

# Get the correct base path (for PyInstaller or normal script execution)
BASE_PATH = getattr(sys, '_MEIPASS', os.path.abspath("."))

# Define directory paths
manual_data_dir = os.path.join(BASE_PATH, "manual_data")
history_dir = os.path.join(BASE_PATH, "history")

# Ensure directories exist before using them
os.makedirs(manual_data_dir, exist_ok=True)
os.makedirs(history_dir, exist_ok=True)

# Define file paths
blacklist_file = os.path.join(manual_data_dir, "blacklist.txt")
whitelist_file = os.path.join(manual_data_dir, "whitelist.txt")
blocked_domains_file = os.path.join(history_dir, "blocked_domains.txt")
deleted_files_file = os.path.join(history_dir, "deleted_files.txt")
downloaded_files_file = os.path.join(history_dir, "downloaded_files.txt")


def is_file_malicious(yara_rules_dir: str, file_to_scan: str) -> bool:

    yara_rules_files = [os.path.join(yara_rules_dir, f) for f in os.listdir(yara_rules_dir) if f.endswith('.yar')]   
    external_variables = {"filepath": file_to_scan}    

    for rule_file in yara_rules_files:
        try:
            rules = yara.compile(filepath=rule_file)            
            matches = rules.match(filepath=file_to_scan, externals=external_variables)         
            if matches:
                print(f"Malicious content detected by {rule_file}")
                return True        

        except Exception as e:
            print(f"Error in {rule_file}: {e}")
            continue

    return False

def calculate_file_hash(file_path):
    hash_sha256 = hashlib.sha256()
    with open(file_path, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha256.update(chunk)
    return hash_sha256.hexdigest()

def get_hashes_from_blacklist(blacklist_file):
    try:
        with open(blacklist_file, 'r', encoding='utf-8') as f:
            return {line.strip() for line in f if line.strip()}
    except FileNotFoundError:
        print(f"Warning: Blacklist file '{blacklist_file}' not found.")
        return set()
    except Exception as e:
        print(f"Error reading blacklist file '{blacklist_file}': {e}")
        return set()


def get_download_folder():
    home = str(pathlib.Path.home())
    if platform.system() in ["Windows", "Darwin", "Linux"]:
        return os.path.join(home, "Downloads")
    else:
        raise Exception("Unsupported operating system")

def process_files(download_directory, blacklist_file, last_scan_time, dashboard):    

    for root, dirs, files in os.walk(download_directory):
        for file in files:
            
            file_path = os.path.join(root, file)
            try:
                mtime = os.path.getmtime(file_path)

                if mtime > last_scan_time:

                    append_to_file(downloaded_files_file, file_path)
                    dashboard.setup_downloaded_files_tab()
                    print("Updated Download History")
                    file_hash = calculate_file_hash(file_path)
                    blacklist_hashes = get_hashes_from_blacklist(blacklist_file)
                    # blacklist_hashes = get_sha256_hashes()
                    if file_hash in blacklist_hashes:
                        print(f"Deleting file: {file_path} (Hash: {file_hash})")
                        os.remove(file_path)  
                        append_to_file(deleted_files_file, file_path)
                        dashboard.setup_deleted_files_tab()
                    else:
                        if is_file_malicious("yara", file_path):
                            print(f"Deleting file: {file_path} (Hash: {file_hash})")
                            os.remove(file_path)  
                            append_to_file(deleted_files_file, file_path)
                            dashboard.setup_deleted_files_tab()
                        else:
                            print(f"File processed and found safe: {file_path} (Hash: {file_hash})")
                            
            except Exception as e:
                print(f"Error processing file {file_path}: {e}")

def start_file_processor(dashboard):
    download_directory = get_download_folder()  
    blacklist_file = "hashes.txt"
    last_scan_time = time.time()

    print(f"Monitoring Download folder: {download_directory}")

    while True:
        process_files(download_directory, blacklist_file, last_scan_time, dashboard)
        last_scan_time = time.time() 
        time.sleep(10)

# if __name__ == "__main__":
#     start_file_processor()